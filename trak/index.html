<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker & Messenger</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background: #f0f0f0; }
        #map { height: 60vh; width: 100%; }
        
        .ui-container { height: 40vh; display: flex; flex-direction: column; }
        
        .tabs { display: flex; background: #ddd; }
        .tab-btn { flex: 1; padding: 10px; border: none; cursor: pointer; background: #ddd; }
        .tab-btn.active { background: #fff; font-weight: bold; border-bottom: 2px solid #2196F3; }

        .content { flex: 1; padding: 15px; overflow-y: auto; background: #fff; }
        .hidden { display: none; }

        /* Стилі повідомлень */
        .msg-item { background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #2196F3; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .update-banner { background: #ff9800; color: white; padding: 10px; text-align: center; display: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="update-banner" class="update-banner" onclick="location.reload(true)">
        Доступне оновлення! Натисніть, щоб перезавантажити.
    </div>

    <div id="map"></div>
    
    <div class="ui-container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('gps')">GPS Дані</button>
            <button class="tab-btn" onclick="showTab('msgs')">Повідомлення (<span id="msg-count">0</span>)</button>
        </div>

        <div id="tab-gps" class="content">
            <div id="status">Статус: Очікування GPS...</div>
            <div id="coords" style="font-size: 14px; margin-top: 10px;"></div>
            <hr>
            <div id="log" style="font-size: 12px; color: #666;"></div>
        </div>

        <div id="tab-msgs" class="content hidden">
            <div id="messages-list">
                <p style="color: #999; text-align: center;">Повідомлень поки немає</p>
            </div>
        </div>
    </div>

    <script>
        const CURRENT_VERSION = "1.0"; // Версія твого коду
        let msgCount = 0;

        // --- ЛОГІКА КАРТИ ---
        const map = L.map('map').setView([48.3794, 31.1656], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = null;
        let path = L.polyline([], {color: 'blue'}).addTo(map);

        // --- ВІДСТЕЖЕННЯ GPS ---
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude, accuracy } = pos.coords;
                const latlng = [latitude, longitude];

                document.getElementById('status').innerHTML = "Статус: <span style='color:green'>Онлайн</span>";
                document.getElementById('coords').innerHTML = `Широта: ${latitude.toFixed(6)}<br>Довгота: ${longitude.toFixed(6)}<br>Точність: ${accuracy.toFixed(1)}м`;

                if (!marker) {
                    marker = L.marker(latlng).addTo(map);
                    map.setView(latlng, 16);
                } else {
                    marker.setLatLng(latlng);
                }
                path.addLatLng(latlng);
            }, null, { enableHighAccuracy: true });
        }

        // --- СИСТЕМА ПОВІДОМЛЕНЬ ---
        function receiveMessage(text) {
            msgCount++;
            document.getElementById('msg-count').innerText = msgCount;
            const list = document.getElementById('messages-list');
            
            if (msgCount === 1) list.innerHTML = ''; // Прибираємо текст "немає повідомлень"

            const item = document.createElement('div');
            item.className = 'msg-item';
            item.innerHTML = `<strong>Нове сповіщення:</strong><br>${text}<br><small>${new Date().toLocaleTimeString()}</small>`;
            list.prepend(item);

            // Вібрація
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }

        // --- ПЕРЕВІРКА ОНОВЛЕНЬ ---
        async function checkUpdates() {
            try {
                // Файл version.json має бути у тебе в репозиторії
                const response = await fetch('version.json?nocache=' + Date.now());
                const data = await response.json();
                if (data.version !== CURRENT_VERSION) {
                    document.getElementById('update-banner').style.display = 'block';
                }
            } catch (e) {
                console.log("Файл версії не знайдено, створюємо імітацію для тесту.");
            }
        }
        setInterval(checkUpdates, 30000); // Перевірка кожні 30 сек

        // --- ПЕРЕМИКАННЯ ВКЛАДОК ---
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
            
            if (tab === 'gps') {
                document.getElementById('tab-gps').classList.remove('hidden');
                document.querySelector('button[onclick*="gps"]').classList.add('active');
            } else {
                document.getElementById('tab-msgs').classList.remove('hidden');
                document.querySelector('button[onclick*="msgs"]').classList.add('active');
                msgCount = 0;
                document.getElementById('msg-count').innerText = "0";
            }
        }

        // Тестове повідомлення для перевірки через 5 секунд після старту
        setTimeout(() => {
            receiveMessage("Тестовий доступ до GPS отримано. Система працює!");
        }, 5000);

    </script>
</body>
</html>